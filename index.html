<html lang="zh-CN"><head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- PWA æ”¯æŒ -->
<meta name="theme-color" content="#B52B2D">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="ç•ªèŒ„é’Ÿ">
<link rel="manifest" href="/manifest.json">
<link rel="icon" href="https://trae-api-cn.mchost.guru/api/ide/v1/text_to_image?prompt=minimalist%20tomato%20timer%20app%20icon%20with%20red%20tomato%20and%20clock%20elements%2C%20clean%20design%2C%20transparent%20background&image_size=square" type="image/png">
<link rel="apple-touch-icon" href="https://trae-api-cn.mchost.guru/api/ide/v1/text_to_image?prompt=minimalist%20tomato%20timer%20app%20icon%20with%20red%20tomato%20and%20clock%20elements%2C%20clean%20design%2C%20transparent%20background&image_size=square">
    <title>æç®€ç•ªèŒ„å·¥ä½œæ³• | è®¡æ—¶+è®¡åˆ’+ä¹ æƒ¯+æ•°æ®åˆ†æ</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome å›¾æ ‡ -->
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <!-- Chart.js è½»é‡å›¾è¡¨ -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.8/dist/chart.umd.min.js"></script>
    <!-- å­—ä½“é…ç½® -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; }
    </style>
    <!-- Tailwind è‡ªå®šä¹‰é…ç½® -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        tomato: '#B52B2D', // ä¸»è‰²ç•ªèŒ„çº¢
                        light: '#F9F9F5',   // èƒŒæ™¯æ·¡é»„è‰²
                        gray-light: '#DFDED7',
                        gray-mid: '#9CA3AF',
                        gray-dark: '#374151',
                    }
                }
            }
        }
    </script>
    <style type="text/tailwindcss">
        @layer utilities {
            .timer-ring { transition: stroke-dashoffset 1s linear; transform: rotate(-90deg); transform-origin: 50% 50%; }
            .collapse-content { max-height: 0; overflow: hidden; transition: max-height 0.3s ease; }
            .collapse-open { max-height: 1000px; }
            .list-hover { @apply hover:bg-light/80 transition-colors; }
            .fade-in { animation: fadeIn 0.3s ease-in-out; }
            .scale-in { animation: scaleIn 0.3s ease-in-out; }
            .bounce-in { animation: bounceIn 0.5s ease-in-out; }
            .drag-item { cursor: grab; user-select: none; }
            .drag-item:active { cursor: grabbing; }
            .card-hover { @apply transition-all duration-200 hover:shadow-md hover:-translate-y-0.5; }
            .glass-effect { @apply backdrop-blur-sm bg-white/80 border border-white/20; }
            /* æ–°å¢ï¼šä¸»é¢˜é¢œè‰²ç±» */
            .bg-primary { background-color: var(--primary-color) !important; }
            .text-primary { color: var(--primary-color) !important; }
            .border-primary { border-color: var(--primary-color) !important; }
            .ring-primary { ring-color: var(--primary-color) !important; }
            .stroke-primary { stroke: var(--primary-color) !important; }
            .hover\:bg-primary\/90:hover { background-color: color-mix(in srgb, var(--primary-color) 90%, transparent) !important; }
            .hover\:bg-primary\/80:hover { background-color: color-mix(in srgb, var(--primary-color) 80%, transparent) !important; }
            .hover\:bg-primary\/70:hover { background-color: color-mix(in srgb, var(--primary-color) 70%, transparent) !important; }
        }
        
        /* æ·±è‰²æ¨¡å¼æ ·å¼ */
        .dark {
            --bg-color: #1a1a1a;
            --text-color: #e5e5e5;
            --light-color: #2d2d2d;
            --gray-dark: #b0b0b0;
            --gray-mid: #808080;
            --tomato-color: #ff6b6b;
        }
        
        .dark body {
            background-color: var(--bg-color);
            color: var(--text-color);
        }
        
        .dark .bg-light {
            background-color: var(--light-color);
        }
        
        .dark .text-gray-dark {
            color: var(--gray-dark);
        }
        
        .dark .text-gray-mid {
            color: var(--gray-mid);
        }
        
        .dark .border-light {
            border-color: var(--light-color);
        }
        
        .dark .hover\:bg-light\/80:hover {
            background-color: rgba(45, 45, 45, 0.8);
        }
        
        .dark .opacity-60 {
            opacity: 0.6;
        }
        
        /* æ•°æ®åˆ†ææ¨¡å—æ·±è‰²æ¨¡å¼æ ·å¼ */
        .dark #no-data-message {
            background-color: var(--light-color) !important;
        }
        
        .dark #no-data-message h4 {
            color: var(--text-color) !important;
        }
        
        .dark #no-data-message p {
            color: var(--gray-mid) !important;
        }
        
        /* ç¡®ä¿å›¾è¡¨å®¹å™¨åœ¨æ·±è‰²æ¨¡å¼ä¸‹æœ‰æ­£ç¡®çš„èƒŒæ™¯ */
        .dark #data-chart-collapse {
            background-color: var(--light-color) !important;
            border-radius: 0.375rem !important;
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        @keyframes scaleIn {
            from { transform: scale(0.8); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }
        @keyframes bounceIn {
            0% { transform: scale(0.3); opacity: 0; }
            50% { transform: scale(1.05); }
            70% { transform: scale(0.9); }
            100% { transform: scale(1); opacity: 1; }
        }
    </style>
</head>
<body class="bg-light min-h-screen py-4 px-4">
    <div class="max-w-6xl mx-auto grid grid-cols-1 lg:grid-cols-3 gap-6 relative">
        <!-- æ–°å¢ï¼šå³ä¸Šè§’è®¾ç½®æŒ‰é’® -->
        <div class="absolute top-0 right-0 z-10">
            <button id="settings-toggle" class="p-2 bg-light rounded-full hover:bg-light/80 transition-colors text-gray-dark">
                <i class="fa fa-cog"></i>
            </button>
        </div>
        
        <!-- æ–°å¢ï¼šè®¾ç½®é¢æ¿ -->
        <div id="settings-panel" class="fixed inset-0 bg-black/50 z-50 hidden flex items-center justify-center p-4">
            <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl max-w-md w-full max-h-[80vh] overflow-y-auto">
                <div class="flex justify-between items-center p-4 border-b border-light dark:border-gray-700">
                    <h3 class="text-lg font-bold text-gray-dark">è®¾ç½®</h3>
                    <button id="close-settings" class="text-gray-mid hover:text-primary">
                        <i class="fa fa-times"></i>
                    </button>
                </div>
                <div class="p-4 space-y-4">
                    <!-- æ—¶é—´è®¾ç½® -->
                    <div class="space-y-2">
                        <h4 class="font-medium text-gray-dark flex items-center gap-2">
                            <i class="fa fa-clock-o text-primary"></i> æ—¶é—´è®¾ç½®
                        </h4>
                        <div class="grid grid-cols-2 gap-3">
                            <div>
                                <label for="work-time" class="block text-xs text-gray-mid mb-1">å·¥ä½œæ—¶é—´(åˆ†é’Ÿ)</label>
                                <input type="number" id="work-time" class="w-full px-2 py-1.5 border border-light dark:border-gray-600 rounded-full focus:outline-none focus:ring-1 focus:ring-primary text-sm" value="25" min="1" max="60">
                            </div>
                            <div>
                                <label for="break-time" class="block text-xs text-gray-mid mb-1">ä¼‘æ¯æ—¶é—´(åˆ†é’Ÿ)</label>
                                <input type="number" id="break-time" class="w-full px-2 py-1.5 border border-light dark:border-gray-600 rounded-full focus:outline-none focus:ring-1 focus:ring-primary text-sm" value="5" min="1" max="30">
                            </div>
                        </div>
                    </div>
                    
                    <!-- ä¸»é¢˜è®¾ç½® -->
                    <div class="space-y-2">
                        <h4 class="font-medium text-gray-dark flex items-center gap-2">
                            <i class="fa fa-paint-brush text-primary"></i> ä¸»é¢˜è®¾ç½®
                        </h4>
                        <div class="flex gap-2 mb-2">
                            <button id="theme-toggle" class="flex-1 px-3 py-1.5 bg-primary text-black rounded-full hover:bg-primary/90 text-sm">
                                <i class="fa fa-moon-o"></i> æ·±è‰²æ¨¡å¼
                            </button>
                            <select id="primary-color" class="flex-1 px-2 py-1.5 border border-light dark:border-gray-600 rounded-full focus:outline-none focus:ring-1 focus:ring-primary text-sm">
                                <option value="tomato">ç•ªèŒ„çº¢</option>
                                <option value="blue">æ·±æµ·è“</option>
                                <option value="green">æ£®æ—ç»¿</option>
                                <option value="purple">è–°è¡£è‰ç´«</option>
                            </select>
                        </div>
                        <div class="flex gap-2">
                            <span class="text-xs text-gray-mid flex items-center">å­—ä½“å¤§å°ï¼š</span>
                            <button data-size="small" class="font-size-btn px-2 py-1 rounded text-xs hover:bg-light/80">å°</button>
                            <button data-size="medium" class="font-size-btn px-2 py-1 rounded text-xs bg-light/80">ä¸­</button>
                            <button data-size="large" class="font-size-btn px-2 py-1 rounded text-xs hover:bg-light/80">å¤§</button>
                        </div>
                    </div>
                    
                    <!-- ç™½å™ªéŸ³è®¾ç½® -->
                    <div class="space-y-2">
                        <h4 class="font-medium text-gray-dark flex items-center gap-2">
                            <i class="fa fa-music text-primary"></i> ç™½å™ªéŸ³
                        </h4>
                        <div class="flex gap-2 mb-2">
                            <button id="whitenoise-toggle" class="flex-1 px-3 py-1.5 bg-light dark:bg-gray-700 text-gray-dark rounded-full hover:bg-light/80 text-sm">
                                <i class="fa fa-volume-up"></i> å¼€å¯
                            </button>
                            <select id="whitenoise-type" class="flex-1 px-2 py-1.5 border border-light dark:border-gray-600 rounded-full focus:outline-none focus:ring-1 focus:ring-primary text-sm">
                                <option value="cafe">å’–å•¡é¦†</option>
                                <option value="rain">é›¨å£°</option>
                                <option value="library">å›¾ä¹¦é¦†</option>
                                <option value="nature">è‡ªç„¶éŸ³</option>
                            </select>
                        </div>
                        <div class="flex items-center gap-2">
                            <span class="text-xs text-gray-mid">éŸ³é‡ï¼š</span>
                            <input type="range" id="whitenoise-volume" min="0" max="1" step="0.1" value="0.5" class="flex-1">
                            <label class="text-xs text-gray-mid">
                                <input type="checkbox" id="play-during-break"> ä¼‘æ¯æ—¶æ’­æ”¾
                            </label>
                        </div>
                    </div>
                    
                    <!-- æ•°æ®å¤‡ä»½ -->
                    <div class="space-y-2">
                        <h4 class="font-medium text-gray-dark flex items-center gap-2">
                            <i class="fa fa-download text-primary"></i> æ•°æ®å¤‡ä»½
                        </h4>
                        <div class="flex gap-2">
                            <button id="export-data" class="flex-1 px-3 py-1.5 bg-primary text-black rounded-full hover:bg-primary/90 text-sm">å¯¼å‡ºæ•°æ®</button>
                            <button id="import-data" class="flex-1 px-3 py-1.5 bg-light dark:bg-gray-700 text-gray-dark rounded-full hover:bg-light/80 text-sm">å¯¼å…¥æ•°æ®</button>
                        </div>
                        <input type="file" id="import-file" accept=".txt" class="hidden">
                    </div>
                </div>
            </div>
        </div>
        
        <!-- å·¦ä¾§ï¼šæ ¸å¿ƒç•ªèŒ„è®¡æ—¶å™¨ -->
        <div class="lg:col-span-1 flex flex-col items-center">
            <h1 class="text-[clamp(1.5rem,3vw,2rem)] font-bold text-gray-dark mb-4">ç•ªèŒ„å·¥ä½œæ³•</h1>
            
            <!-- ç•ªèŒ„è®¡æ—¶åœ†ç¯ -->
            <div class="relative w-56 h-56 mb-4">
                <svg class="w-full h-full" viewBox="0 0 100 100">
                    <circle cx="50" cy="50" r="45" fill="none" class="stroke-primary" stroke-width="4"></circle>
                    <circle id="timer-ring" class="timer-ring cx-50 cy-50 r-45 fill-none stroke-transparent stroke-4" stroke-dasharray="282.74" stroke-dashoffset="0"></circle>
                </svg>
                <div class="absolute inset-0 flex flex-col items-center justify-center">
                    <span id="timer-display" class="text-[clamp(1.8rem,4vw,2.5rem)] font-bold text-gray-dark">25:00</span>
                    <span id="timer-status" class="text-sm text-primary/80 mt-1">å‡†å¤‡å¼€å§‹å·¥ä½œ</span>
                </div>
            </div>

            <!-- è®¡æ—¶æ§åˆ¶æŒ‰é’® -->
            <div class="flex space-x-3 mb-4">
                <button id="start-btn" class="px-5 py-2 bg-primary text-white rounded-full hover:bg-primary/90 transition-colors flex items-center gap-2">
                    <i class="fa fa-play"></i> å¼€å§‹
                </button>
                <button id="reset-btn" class="px-5 py-2 bg-light text-gray-dark rounded-full hover:bg-light/80 transition-colors flex items-center gap-2">
                    <i class="fa fa-refresh"></i> é‡ç½®
                </button>
            </div>

            <!-- æ¨¡å¼åˆ‡æ¢ -->
            <div class="inline-flex rounded-full mb-4" role="group">
                <button id="work-mode" class="px-5 py-1.5 bg-primary text-white rounded-l-full hover:bg-primary/90 text-sm">å·¥ä½œæ¨¡å¼</button>
                <button id="break-mode" class="px-5 py-1.5 bg-transparent text-gray-dark rounded-r-full hover:bg-primary/10 hover:text-gray-dark text-sm">ä¼‘æ¯æ¨¡å¼</button>
            </div>

            <!-- ç•ªèŒ„æ ‡ç­¾ -->
            <div class="w-full bg-light rounded-lg p-3 mb-4">
                <h3 class="font-medium text-gray-dark mb-2 flex items-center gap-2 text-sm"><i class="fa fa-tag text-primary"></i> ç•ªèŒ„æ ‡ç­¾</h3>
                <div class="flex gap-2">
                    <button id="tag-work" class="flex-1 py-1.5 bg-transparent text-gray-dark rounded-full text-sm">å·¥ä½œ</button>
                    <button id="tag-study" class="flex-1 py-1.5 bg-transparent text-gray-dark rounded-full text-sm">å­¦ä¹ </button>
                    <button id="tag-life" class="flex-1 py-1.5 bg-transparent text-gray-dark rounded-full text-sm">ç”Ÿæ´»</button>
                </div>
            </div>



            <!-- ä»Šæ—¥ç•ªèŒ„ç®€æ˜“ç»Ÿè®¡ -->
            <div class="w-full bg-light rounded-lg p-3 mb-4">
                <h3 class="font-medium text-gray-dark mb-2 flex items-center gap-2 text-sm"><i class="fa fa-tomato text-primary"></i> ä»Šæ—¥ç»Ÿè®¡</h3>
                <div class="grid grid-cols-3 gap-2 text-center">
                    <div>
                        <p class="text-xs text-gray-mid">å·²å®Œæˆ</p>
                        <p id="completed-pomodoros" class="text-lg font-bold text-primary">0</p>
                    </div>
                    <div>
                        <p class="text-xs text-gray-mid">ä¸“æ³¨æ—¶é•¿</p>
                        <p id="focus-time" class="text-lg font-bold text-primary">0åˆ†é’Ÿ</p>
                    </div>
                    <div>
                        <p class="text-xs text-gray-mid">è¿ç»­å®Œæˆ</p>
                        <p id="current-streak" class="text-lg font-bold text-primary">0</p>
                    </div>
                </div>
            </div>


        </div>

        <!-- å³ä¾§ï¼šè®¡åˆ’/ä¹ æƒ¯/ç›®æ ‡ -->
        <div class="lg:col-span-2 flex flex-col gap-4">
            <!-- ä»Šæ—¥è®¡åˆ’æ¨¡å— -->
            <div class="bg-light rounded-lg p-3 card-hover">
                <div class="flex justify-between items-center mb-3 cursor-pointer" id="plan-collapse-header">
                    <h3 class="font-medium text-gray-dark flex items-center gap-2 text-sm"><i class="fa fa-list-alt text-primary"></i> ä»Šæ—¥è®¡åˆ’</h3>
                    <div class="flex items-center gap-2">
                        <button id="save-template-btn" class="text-xs text-blue hover:text-blue/80" title="ä¿å­˜ä¸ºæ¨¡æ¿">
                            <i class="fa fa-save"></i> ä¿å­˜æ¨¡æ¿
                        </button>
                        <select id="template-select" class="text-xs border border-light rounded px-1 py-0.5">
                            <option value="">åŠ è½½æ¨¡æ¿</option>
                        </select>
                        <span class="text-gray-mid text-xs"><i class="fa fa-chevron-down" id="plan-collapse-icon"></i></span>
                    </div>
                </div>
                <!-- è®¡åˆ’æ·»åŠ  -->
                <div class="flex flex-col gap-2 mb-3 collapse-content collapse-open" id="plan-collapse">
                    <div class="flex gap-2">
                        <input type="text" id="plan-input" placeholder="è¾“å…¥ä»Šæ—¥è®¡åˆ’ï¼ˆå¦‚ï¼šå†™æŠ¥å‘Šï¼‰" class="flex-1 px-2 py-1.5 border border-light rounded-full focus:outline-none focus:ring-1 focus:ring-primary text-sm">
                        <input type="number" id="plan-pomo" placeholder="é¢„è®¡ç•ªèŒ„æ•°" class="w-16 px-2 py-1.5 border border-light rounded-full focus:outline-none focus:ring-1 focus:ring-primary text-sm" min="1" value="1">
                        <select id="plan-priority" class="w-16 px-2 py-1.5 border border-light rounded-full focus:outline-none focus:ring-1 focus:ring-primary text-sm">
                            <option value="high">é«˜</option>
                            <option value="medium" selected="">ä¸­</option>
                            <option value="low">ä½</option>
                        </select>
                    </div>
                    <!-- æ–°å¢ï¼šç›®æ ‡å…³è” -->
                    <div class="flex gap-2">
                        <select id="goal-select" class="flex-1 px-2 py-1.5 border border-light rounded-full focus:outline-none focus:ring-1 focus:ring-primary text-sm">
                            <option value="">å…³è”ç›®æ ‡ï¼ˆå¯é€‰ï¼‰</option>
                        </select>
                        <select id="stage-select" class="flex-1 px-2 py-1.5 border border-light rounded-full focus:outline-none focus:ring-1 focus:ring-primary text-sm" disabled="">
                            <option value="">é€‰æ‹©é˜¶æ®µ</option>
                        </select>
                    </div>
                    <button id="add-plan" class="w-full px-3 py-1.5 bg-primary text-white rounded-full hover:bg-primary/90 text-sm">æ·»åŠ è®¡åˆ’</button>
                </div>
                <!-- è®¡åˆ’åˆ—è¡¨ -->
                <div id="plan-list" class="space-y-2 collapse-content collapse-open">
                    <div class="text-center text-gray-mid py-3 text-sm" id="plan-empty">æš‚æ— ä»Šæ—¥è®¡åˆ’ï¼Œæ·»åŠ å¼€å§‹ä½ çš„é«˜æ•ˆä¸€å¤©å§ï½</div>
                </div>
            </div>

            <!-- æ—¥å¸¸ä¹ æƒ¯æ¨¡å— -->
            <div class="bg-light rounded-lg p-3 card-hover">
                <div class="flex justify-between items-center mb-3 cursor-pointer" id="habit-collapse-header">
                    <h3 class="font-medium text-gray-dark flex items-center gap-2 text-sm"><i class="fa fa-calendar-check-o text-primary"></i> æ—¥å¸¸ä¹ æƒ¯</h3>
                    <span class="text-gray-mid text-xs"><i class="fa fa-chevron-down" id="habit-collapse-icon"></i></span>
                </div>
                <!-- ä¹ æƒ¯æ·»åŠ  -->
                <div class="flex flex-col gap-2 mb-3 collapse-content" id="habit-collapse">
                    <div class="flex gap-2">
                        <input type="text" id="habit-input" placeholder="è¾“å…¥æ—¥å¸¸ä¹ æƒ¯ï¼ˆå¦‚ï¼šé˜…è¯»30åˆ†é’Ÿï¼‰" class="flex-1 px-2 py-1.5 border border-light rounded-full focus:outline-none focus:ring-1 focus:ring-primary text-sm">
                        <select id="habit-type" class="px-2 py-1.5 border border-light rounded-full focus:outline-none focus:ring-1 focus:ring-primary text-sm">
                            <option value="daily">æ¯æ—¥ä¹ æƒ¯</option>
                            <option value="weekly">æ¯å‘¨ä¹ æƒ¯</option>
                        </select>
                    </div>
                    <div class="flex gap-2">
                        <input type="time" id="habit-reminder" class="flex-1 px-2 py-1.5 border border-light rounded-full focus:outline-none focus:ring-1 focus:ring-primary text-sm" placeholder="æé†’æ—¶é—´ï¼ˆå¯é€‰ï¼‰">
                        <button id="add-habit" class="px-3 py-1.5 bg-primary text-white rounded-full hover:bg-primary/90 text-sm">æ·»åŠ ä¹ æƒ¯</button>
                    </div>
                </div>
                <!-- ä¹ æƒ¯åˆ—è¡¨ -->
                <div id="habit-list" class="space-y-2 collapse-content">
                    <div class="text-center text-gray-mid py-3 text-sm" id="habit-empty">æš‚æ— æ·»åŠ ä¹ æƒ¯ï¼ŒåŸ¹å…»è‡ªå¾‹ä»è¿™é‡Œå¼€å§‹ï½</div>
                </div>
            </div>

            <!-- é•¿æœŸç›®æ ‡æ¨¡å— -->
            <div class="bg-light rounded-lg p-3 card-hover">
                <div class="flex justify-between items-center mb-3 cursor-pointer" id="goal-collapse-header">
                    <h3 class="font-medium text-gray-dark flex items-center gap-2 text-sm"><i class="fa fa-flag text-primary"></i> é•¿æœŸç›®æ ‡</h3>
                    <span class="text-gray-mid text-xs"><i class="fa fa-chevron-down" id="goal-collapse-icon"></i></span>
                </div>
                <!-- ç›®æ ‡æ·»åŠ  -->
                <div class="flex flex-col gap-2 mb-3 collapse-content" id="goal-collapse">
                    <div class="flex gap-2">
                        <input type="text" id="goal-input" placeholder="è¾“å…¥é•¿æœŸç›®æ ‡ï¼ˆå¦‚ï¼šå­¦ä¼šPythonï¼‰" class="flex-1 px-2 py-1.5 border border-light rounded-full focus:outline-none focus:ring-1 focus:ring-primary text-sm">
                        <input type="number" id="goal-stage" placeholder="é˜¶æ®µæ•°" class="w-16 px-2 py-1.5 border border-light rounded-full focus:outline-none focus:ring-1 focus:ring-primary text-sm" min="1" value="3">
                    </div>
                    <button id="add-goal" class="w-full px-3 py-1.5 bg-primary text-white rounded-full hover:bg-primary/90 text-sm">æ·»åŠ ç›®æ ‡</button>
                </div>
                <!-- ç›®æ ‡åˆ—è¡¨ -->
                <div id="goal-list" class="space-y-3 collapse-content">
                    <div class="text-center text-gray-mid py-3 text-sm" id="goal-empty">æš‚æ— é•¿æœŸç›®æ ‡ï¼Œç«‹ä¸‹ä½ çš„flagå§ï½</div>
                </div>
            </div>

            <!-- æ•°æ®åˆ†ææ¨¡å— -->
            <div class="bg-light rounded-lg p-3 card-hover">
                <div class="flex justify-between items-center mb-3 cursor-pointer" id="data-collapse-header">
                    <h3 class="font-medium text-gray-dark flex items-center gap-2 text-sm"><i class="fa fa-bar-chart text-primary"></i> æ•°æ®åˆ†æ</h3>
                    <span class="text-gray-mid text-xs"><i class="fa fa-chevron-down" id="data-collapse-icon"></i></span>
                </div>
                <!-- æ•°æ®ç»´åº¦åˆ‡æ¢ -->
                <div class="flex gap-2 mb-3 collapse-content" id="data-collapse">
                    <button class="data-tab active px-3 py-1 rounded-full bg-primary text-white text-xs" data-tab="day">ä»Šæ—¥</button>
                    <button class="data-tab px-3 py-1 rounded-full bg-light text-gray-dark text-xs" data-tab="week">æœ¬å‘¨</button>
                    <button class="data-tab px-3 py-1 rounded-full bg-light text-gray-dark text-xs" data-tab="month">æœ¬æœˆ</button>
                </div>
                <!-- å›¾è¡¨å®¹å™¨ -->
                <div class="h-48 collapse-content collapse-open relative" id="data-chart-collapse">
                    <canvas id="pomodoro-chart"></canvas>
                    <div id="no-data-message" class="absolute inset-0 flex flex-col items-center justify-center text-gray-mid bg-light rounded-lg">
                        <div class="text-primary text-5xl mb-3">ğŸ“Š</div>
                        <h4 class="font-medium text-gray-dark mb-1">å¼€å§‹ä½ çš„ç•ªèŒ„ä¹‹æ—…</h4>
                        <p class="text-sm text-center max-w-xs px-4">å®Œæˆç¬¬ä¸€ä¸ªç•ªèŒ„é’Ÿåï¼Œè¿™é‡Œä¼šæ˜¾ç¤ºä½ çš„ä¸“æ³¨æ•°æ®å’Œè¶‹åŠ¿å›¾è¡¨</p>
                        <button id="start-first-pomo-btn" class="mt-3 px-4 py-1.5 bg-primary text-white rounded-full text-sm hover:bg-primary/90">
                            <i class="fa fa-play mr-1"></i> å¼€å§‹ç¬¬ä¸€ä¸ªç•ªèŒ„
                        </button>
                    </div>
                </div>
                <!-- æ•°æ®æŒ‡æ ‡ -->
                <div class="grid grid-cols-2 md:grid-cols-4 gap-2 mt-3 collapse-content" id="data-metric-collapse">
                    <div class="bg-light p-2 rounded-lg text-center">
                        <p class="text-xs text-gray-mid">ç•ªèŒ„å®Œæˆç‡</p>
                        <p id="pomo-rate" class="font-bold text-primary text-sm">0%</p>
                    </div>
                    <div class="bg-light p-2 rounded-lg text-center">
                        <p class="text-xs text-gray-mid">è®¡åˆ’å®Œæˆç‡</p>
                        <p id="plan-rate" class="font-bold text-primary text-sm">0%</p>
                    </div>
                    <div class="bg-light p-2 rounded-lg text-center">
                        <p class="text-xs text-gray-mid">ä¹ æƒ¯æ‰“å¡ç‡</p>
                        <p id="habit-rate" class="font-bold text-primary text-sm">0%</p>
                    </div>
                    <div class="bg-light p-2 rounded-lg text-center">
                        <p class="text-xs text-gray-mid">å¹³å‡ä¸“æ³¨æ—¶é•¿</p>
                        <p id="avg-focus" class="font-bold text-primary text-sm">0åˆ†é’Ÿ</p>
                    </div>
                </div>
                
                <!-- ç•ªèŒ„æ˜ç»† -->
                <div class="mt-3 collapse-content" id="pomo-detail-collapse">
                    <div class="flex justify-between items-center mb-2">
                        <h4 class="font-medium text-gray-dark text-sm">ç•ªèŒ„æ˜ç»†</h4>
                        <select id="pomo-tag-filter" class="px-2 py-1 border border-light rounded-full text-xs focus:outline-none focus:ring-1 focus:ring-primary">
                            <option value="all">å…¨éƒ¨æ ‡ç­¾</option>
                            <option value="work">å·¥ä½œ</option>
                            <option value="study">å­¦ä¹ </option>
                            <option value="life">ç”Ÿæ´»</option>
                        </select>
                    </div>
                    <div id="pomo-detail-list" class="max-h-32 overflow-y-auto text-sm">
                        <div class="text-center text-gray-mid py-2 text-xs">æš‚æ— ç•ªèŒ„è®°å½•</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ================= å…¨å±€çŠ¶æ€ä¸DOMå…ƒç´  =================
        let timer = null;
        let isRunning = false;
        let isWorkMode = true;
        let timeLeft = 25 * 60;
        let workTime = 25 * 60;
        let breakTime = 5 * 60;
        let currentBindPlan = null; // å½“å‰å…³è”çš„ä»Šæ—¥è®¡åˆ’ID
        let currentPomoTag = 'work'; // å½“å‰ç•ªèŒ„æ ‡ç­¾ï¼šwork/study/life

        // ç»Ÿè®¡æ•°æ®
        let stats = { completedPomodoros: 0, focusTime: 0, currentStreak: 0 };
        // æ¨¡å—æ•°æ®ï¼ˆè®¡åˆ’/ä¹ æƒ¯/ç›®æ ‡ï¼‰
        let plans = JSON.parse(localStorage.getItem('pomodoroPlans')) || [];
        let habits = JSON.parse(localStorage.getItem('pomodoroHabits')) || [];
        let goals = JSON.parse(localStorage.getItem('pomodoroGoals')) || [];
        // æ–°å¢ï¼šè®¡åˆ’æ¨¡æ¿
        let planTemplates = JSON.parse(localStorage.getItem('pomodoroPlanTemplates')) || [];
        // æ–°å¢ï¼šç”¨æˆ·è®¾ç½®
        let settings = JSON.parse(localStorage.getItem('pomodoroSettings')) || {
            theme: 'light', // light, dark
            primaryColor: 'tomato', // tomato, blue, green, purple
            fontSize: 'medium', // small, medium, large
            whiteNoise: {
                enabled: false,
                type: 'cafe', // cafe, rain, library, nature
                volume: 0.5,
                playDuringBreak: false
            }
        };
        // æ‰“å¡/å®Œæˆè®°å½•
        let records = JSON.parse(localStorage.getItem('pomodoroRecords')) || {
            pomo: [], plan: [], habit: [], focus: []
        };
        // æ–°å¢ï¼šç™½å™ªéŸ³éŸ³é¢‘å¯¹è±¡
        let audioContext = null;
        let currentAudio = null;

        // DOMå…ƒç´ 
        const [timerDisplay, timerStatus, timerRing] = ['timer-display', 'timer-status', 'timer-ring'].map(id => document.getElementById(id));
        const [startBtn, resetBtn, workMode, breakMode] = ['start-btn', 'reset-btn', 'work-mode', 'break-mode'].map(id => document.getElementById(id));
        const [workTimeInput, breakTimeInput] = ['work-time', 'break-time'].map(id => document.getElementById(id));
        const [completedPomodoros, focusTime, currentStreak] = ['completed-pomodoros', 'focus-time', 'current-streak'].map(id => document.getElementById(id));
        // è®¡åˆ’æ¨¡å—
        const [planInput, planPomo, addPlan, planList, planEmpty] = ['plan-input', 'plan-pomo', 'add-plan', 'plan-list', 'plan-empty'].map(id => document.getElementById(id));
        // ä¹ æƒ¯æ¨¡å—
        const [habitInput, habitType, addHabit, habitList, habitEmpty] = ['habit-input', 'habit-type', 'add-habit', 'habit-list', 'habit-empty'].map(id => document.getElementById(id));
        // ç›®æ ‡æ¨¡å—
        const [goalInput, goalStage, addGoal, goalList, goalEmpty] = ['goal-input', 'goal-stage', 'add-goal', 'goal-list', 'goal-empty'].map(id => document.getElementById(id));
        // æŠ˜å æ¨¡å—
        const collapseHeaders = ['plan', 'habit', 'goal', 'data'].map(prefix => document.getElementById(`${prefix}-collapse-header`));
        const collapseIcons = ['plan', 'habit', 'goal', 'data'].map(prefix => document.getElementById(`${prefix}-collapse-icon`));
        const collapseContents = ['plan', 'habit', 'goal', 'data'].map(prefix => [
            document.getElementById(`${prefix}-collapse`),
            document.getElementById(`${prefix}-list-collapse`) || document.getElementById(`${prefix}-chart-collapse`),
            document.getElementById(`${prefix}-metric-collapse`) || null
        ]).flat().filter(Boolean);
        // æ•°æ®åˆ†æ
        const dataTabs = document.querySelectorAll('.data-tab');
        const pomodoroChart = document.getElementById('pomodoro-chart');
        let chartInstance = null;
        const [pomoRate, planRate, habitRate, avgFocus] = ['pomo-rate', 'plan-rate', 'habit-rate', 'avg-focus'].map(id => document.getElementById(id));

        // ================= åˆå§‹åŒ– =================
        init();
        function init() {
            // åŠ è½½æœ¬åœ°å­˜å‚¨çš„æ•°æ®
            records = JSON.parse(localStorage.getItem('pomodoroRecords')) || {
                pomo: [], plan: [], habit: [], focus: []
            };
            plans = JSON.parse(localStorage.getItem('pomodoroPlans')) || [];
            habits = JSON.parse(localStorage.getItem('pomodoroHabits')) || [];
            goals = JSON.parse(localStorage.getItem('pomodoroGoals')) || [];
            planTemplates = JSON.parse(localStorage.getItem('pomodoroPlanTemplates')) || [];
            
            // é‡ç½®ç»Ÿè®¡æ•°æ®ï¼Œæ”¹ä¸ºä»recordsè®¡ç®—
            stats = {
                completedPomodoros: 0,
                focusTime: 0,
                currentStreak: 0
            };
            
            // åˆå§‹åŒ–åœ†ç¯
            const ringRadius = timerRing.r.baseVal.value;
            const ringCircumference = 2 * Math.PI * ringRadius;
            timerRing.style.strokeDasharray = ringCircumference;
            // ç»‘å®šäº‹ä»¶
            bindEvents();
            // æ¸²æŸ“æ¨¡å—
            renderPlans();
            renderHabits();
            renderGoals();
            renderPomoDetail();
            // æ›´æ–°è®¡æ—¶å™¨å’Œç»Ÿè®¡
            updateTimerDisplay();
            updateStatsDisplay();
            // åˆå§‹åŒ–å›¾è¡¨
            initChart('day');
            // æ›´æ–°æ•°æ®æŒ‡æ ‡
            updateDataMetrics('day');
            // å¯åŠ¨ä¹ æƒ¯æé†’æ£€æŸ¥ï¼ˆæ¯åˆ†é’Ÿæ£€æŸ¥ä¸€æ¬¡ï¼‰
            setInterval(checkHabitReminders, 60000);
            // ç«‹å³æ£€æŸ¥ä¸€æ¬¡
            checkHabitReminders();
            
            // æ–°å¢ï¼šåˆå§‹åŒ–ä¸»é¢˜
            applyTheme();
            
            // æ–°å¢ï¼šåˆå§‹åŒ–æ¨¡æ¿é€‰æ‹©å™¨
            updateTemplateSelect();
            
            // æ–°å¢ï¼šåˆå§‹åŒ–ç›®æ ‡é€‰æ‹©å™¨
            updateGoalSelect();
            
            // æ–°å¢ï¼šè®¾ç½®åˆå§‹ç™½å™ªéŸ³çŠ¶æ€
            if (settings.whiteNoise.enabled) {
                document.getElementById('whitenoise-toggle').innerHTML = '<i class="fa fa-volume-off"></i> å…³é—­';
            } else {
                document.getElementById('whitenoise-toggle').innerHTML = '<i class="fa fa-volume-up"></i> å¼€å¯';
            }
            
            // æ–°å¢ï¼šè®¾ç½®åˆå§‹éŸ³é‡
            document.getElementById('whitenoise-volume').value = settings.whiteNoise.volume;
            
            // æ–°å¢ï¼šè®¾ç½®ä¼‘æ¯æ—¶æ’­æ”¾é€‰é¡¹
            document.getElementById('play-during-break').checked = settings.whiteNoise.playDuringBreak;
            
            // æ–°å¢ï¼šè®¾ç½®åˆå§‹ä¸»è‰²
            document.getElementById('primary-color').value = settings.primaryColor;
            
            // æ–°å¢ï¼šè®¾ç½®åˆå§‹å­—ä½“å¤§å°æŒ‰é’®çŠ¶æ€
            document.querySelectorAll('.font-size-btn').forEach(btn => {
                if (btn.dataset.size === settings.fontSize) {
                    btn.classList.add('bg-light/80');
                }
            });
        }

        // ================= ç•ªèŒ„è®¡æ—¶å™¨æ ¸å¿ƒåŠŸèƒ½ =================
        // æ ¼å¼åŒ–æ—¶é—´ï¼šç§’ -> MM:SS
        function formatTime(seconds) {
            const mins = Math.floor(seconds / 60);
            const secs = seconds % 60;
            return `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
        }
        // æ›´æ–°åœ†ç¯è¿›åº¦
        function updateRingProgress(progress) {
            const ringCircumference = 2 * Math.PI * timerRing.r.baseVal.value;
            timerRing.style.strokeDashoffset = ringCircumference * (1 - progress);
        }
        // æ›´æ–°è®¡æ—¶å™¨æ˜¾ç¤º
        function updateTimerDisplay() {
            timerDisplay.textContent = formatTime(timeLeft);
            const totalTime = isWorkMode ? workTime : breakTime;
            const progress = timeLeft / totalTime;
            updateRingProgress(progress);
            // æ›´æ–°çŠ¶æ€æ–‡æœ¬
            if (isRunning) {
                timerStatus.textContent = isWorkMode 
                    ? (currentBindPlan ? `ä¸“æ³¨å·¥ä½œä¸­ï¼ˆå…³è”ï¼š${getPlanName(currentBindPlan)}ï¼‰` : 'ä¸“æ³¨å·¥ä½œä¸­...') 
                    : 'ä¼‘æ¯æ”¾æ¾ä¸­...';
            } else {
                timerStatus.textContent = isWorkMode 
                    ? (currentBindPlan ? `å‡†å¤‡å¼€å§‹ï¼ˆå…³è”ï¼š${getPlanName(currentBindPlan)}ï¼‰` : 'å‡†å¤‡å¼€å§‹å·¥ä½œ') 
                    : 'å‡†å¤‡å¼€å§‹ä¼‘æ¯';
            }
            // æ›´æ–°åœ†ç¯é¢œè‰²
            timerRing.className = 'timer-ring cx-50 cy-50 r-45 fill-none stroke-transparent stroke-4';
            timerRing.style.stroke = 'transparent';
            timerRing.style.opacity = '1';
        }
        // åˆ‡æ¢å·¥ä½œ/ä¼‘æ¯æ¨¡å¼
        function toggleMode(mode) {
            if (isRunning) return;
            isWorkMode = mode === 'work';
            timeLeft = isWorkMode ? workTime : breakTime;
            // æ›´æ–°æŒ‰é’®æ ·å¼
            if (isWorkMode) {
                workMode.classList.add('bg-primary', 'text-white');
                workMode.classList.remove('bg-transparent', 'text-gray-dark');
                breakMode.classList.add('bg-transparent', 'text-gray-dark');
                breakMode.classList.remove('bg-primary', 'text-white');
            } else {
                breakMode.classList.add('bg-primary', 'text-white');
                breakMode.classList.remove('bg-transparent', 'text-gray-dark');
                workMode.classList.add('bg-transparent', 'text-gray-dark');
                workMode.classList.remove('bg-primary', 'text-white');
            }
            
            // æ–°å¢ï¼šå¤„ç†ç™½å™ªéŸ³æ’­æ”¾
            if (settings.whiteNoise.enabled) {
                if (isWorkMode) {
                    // åˆ‡æ¢åˆ°å·¥ä½œæ¨¡å¼ï¼Œæ’­æ”¾ç™½å™ªéŸ³
                    playWhiteNoise();
                } else {
                    // åˆ‡æ¢åˆ°ä¼‘æ¯æ¨¡å¼
                    if (settings.whiteNoise.playDuringBreak) {
                        playWhiteNoise();
                    } else {
                        stopWhiteNoise();
                    }
                }
            }
            
            updateTimerDisplay();
        }
        // å¼€å§‹/æš‚åœè®¡æ—¶å™¨
        function toggleTimer() {
            if (isRunning) {
                clearInterval(timer);
                startBtn.innerHTML = '<i class="fa fa-play"></i> å¼€å§‹';
                timerStatus.textContent = isWorkMode ? 'å·¥ä½œå·²æš‚åœ' : 'ä¼‘æ¯å·²æš‚åœ';
                // åœæ­¢ç™½å™ªéŸ³
                stopWhiteNoise();
            } else {
                // æ’­æ”¾ç™½å™ªéŸ³ï¼ˆå·¥ä½œæ¨¡å¼æˆ–ä¼‘æ¯æ¨¡å¼ä¸”è®¾ç½®äº†ä¼‘æ¯æ—¶æ’­æ”¾ï¼‰
                if (settings.whiteNoise.enabled && (isWorkMode || settings.whiteNoise.playDuringBreak)) {
                    playWhiteNoise();
                }
                
                timer = setInterval(() => {
                    timeLeft--;
                    if (timeLeft <= 0) {
                        clearInterval(timer);
                        isRunning = false;
                        startBtn.innerHTML = '<i class="fa fa-play"></i> å¼€å§‹';
                        // æ’­æ”¾æç¤ºéŸ³
                        new Audio('https://assets.mixkit.co/sfx/preview/mixkit-alarm-digital-clock-beep-989.mp3').play();
                        // å·¥ä½œç»“æŸï¼šç»Ÿè®¡ç•ªèŒ„ã€å…³è”è®¡åˆ’ã€å¼€å§‹ä¸€åˆ†é’Ÿä¼‘æ¯
                        if (isWorkMode) {
                            stats.completedPomodoros++;
                            stats.focusTime += workTime / 60;
                            stats.currentStreak++;
                            updateStatsDisplay();
                            saveStats();
                            // è®°å½•ç•ªèŒ„æ•°æ®
                            recordPomo();
                            // å…³è”è®¡åˆ’ï¼šç´¯è®¡ç•ªèŒ„æ•°
                            if (currentBindPlan) updatePlanPomo(currentBindPlan);
                            timerStatus.textContent = 'å·¥ä½œå®Œæˆï¼å¼€å§‹ä¸€åˆ†é’Ÿä¼‘æ¯';
                            
                            // æ˜¾ç¤ºç•ªèŒ„å®ŒæˆåŠ¨æ•ˆ
                            const timerCircle = document.querySelector('.timer-circle');
                            if (timerCircle) {
                                showCompletionEffect(timerCircle);
                            }
                            
                            // å¼€å§‹ä¸€åˆ†é’Ÿä¼‘æ¯
                            const oneMinuteBreak = 60; // 1åˆ†é’Ÿä¼‘æ¯
                            timeLeft = oneMinuteBreak;
                            isWorkMode = false;
                            updateTimerDisplay();
                            
                            // å¯åŠ¨ä¸€åˆ†é’Ÿä¼‘æ¯è®¡æ—¶å™¨
                            const breakTimer = setInterval(() => {
                                timeLeft--;
                                if (timeLeft <= 0) {
                                    clearInterval(breakTimer);
                                    // ä¸€åˆ†é’Ÿä¼‘æ¯ç»“æŸï¼šè¯¢é—®æ˜¯å¦å¼€å§‹å®Œæ•´ä¼‘æ¯æ¨¡å¼
                                    timerStatus.textContent = 'çŸ­ä¼‘æ¯ç»“æŸï¼';
                                    
                                    // æ˜¾ç¤ºä¼‘æ¯æ¨¡å¼è¯¢é—®
                                    const restModeNotification = document.createElement('div');
                                    restModeNotification.className = 'fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4';
                                    restModeNotification.innerHTML = `
                                        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl max-w-md w-full p-6">
                                            <div class="text-center mb-4">
                                                <div class="text-primary text-4xl mb-3">ğŸ…</div>
                                                <h3 class="text-xl font-bold text-gray-dark">ä¼‘æ¯æ¨¡å¼</h3>
                                                <p class="text-gray-mid mt-2">æ˜¯å¦å¼€å§‹å®Œæ•´çš„ä¼‘æ¯æ¨¡å¼ï¼Ÿ</p>
                                            </div>
                                            <div class="flex gap-3">
                                                <button id="start-rest-mode-btn" class="flex-1 px-4 py-2 bg-primary text-white rounded-full hover:bg-primary/90">
                                                    å¼€å§‹ä¼‘æ¯
                                                </button>
                                                <button id="skip-rest-mode-btn" class="flex-1 px-4 py-2 bg-light dark:bg-gray-700 text-gray-dark rounded-full hover:bg-light/80">
                                                    ç›´æ¥å·¥ä½œ
                                                </button>
                                            </div>
                                        </div>
                                    `;
                                    document.body.appendChild(restModeNotification);
                                    
                                    // è‡ªåŠ¨å¼€å§‹ä¸‹ä¸€ä¸ªå·¥ä½œç•ªèŒ„é’Ÿï¼ˆ10ç§’æ— æ“ä½œï¼‰
                                    const autoStartTimer = setTimeout(() => {
                                        if (document.body.contains(restModeNotification)) {
                                            document.body.removeChild(restModeNotification);
                                            toggleMode('work');
                                            toggleTimer();
                                        }
                                    }, 10000);
                                    
                                    // å¼€å§‹ä¼‘æ¯æ¨¡å¼æŒ‰é’®
                                    const startRestModeBtn = document.getElementById('start-rest-mode-btn');
                                    if (startRestModeBtn) {
                                        startRestModeBtn.addEventListener('click', () => {
                                            clearTimeout(autoStartTimer);
                                            document.body.removeChild(restModeNotification);
                                            // åˆ‡æ¢åˆ°å®Œæ•´çš„ä¼‘æ¯æ¨¡å¼
                                            toggleMode('break');
                                            toggleTimer();
                                        });
                                    }
                                    
                                    // è·³è¿‡ä¼‘æ¯æ¨¡å¼æŒ‰é’®
                                    const skipRestModeBtn = document.getElementById('skip-rest-mode-btn');
                                    if (skipRestModeBtn) {
                                        skipRestModeBtn.addEventListener('click', () => {
                                            clearTimeout(autoStartTimer);
                                            document.body.removeChild(restModeNotification);
                                            // ç›´æ¥å¼€å§‹ä¸‹ä¸€ä¸ªå·¥ä½œç•ªèŒ„é’Ÿ
                                            toggleMode('work');
                                            toggleTimer();
                                        });
                                    }
                                }
                                updateTimerDisplay();
                            }, 1000);
                        } else {
                            // ä¼‘æ¯æ¨¡å¼ç»“æŸï¼šåˆ‡æ¢åˆ°å·¥ä½œæ¨¡å¼
                            timerStatus.textContent = 'ä¼‘æ¯ç»“æŸï¼å¼€å§‹æ–°çš„å·¥ä½œç•ªèŒ„é’Ÿ';
                            setTimeout(() => {
                                toggleMode('work');
                                toggleTimer();
                            }, 2000);
                        }
                    }
                    updateTimerDisplay();
                }, 1000);
                startBtn.innerHTML = '<i class="fa fa-pause"></i> æš‚åœ';
            }
            isRunning = !isRunning;
        }
        // é‡ç½®è®¡æ—¶å™¨
        function resetTimer() {
            clearInterval(timer);
            isRunning = false;
            timeLeft = isWorkMode ? workTime : breakTime;
            startBtn.innerHTML = '<i class="fa fa-play"></i> å¼€å§‹';
            currentBindPlan = null;
            updateTimerDisplay();
        }
        // æ›´æ–°æ—¶é—´è®¾ç½®
        function updateTimeSettings() {
            workTime = parseInt(workTimeInput.value) * 60;
            breakTime = parseInt(breakTimeInput.value) * 60;
            if (!isRunning) {
                timeLeft = isWorkMode ? workTime : breakTime;
                updateTimerDisplay();
            }
        }
        // ä¿å­˜ç»Ÿè®¡æ•°æ®
        function saveStats() {
            localStorage.setItem('pomodoroStats', JSON.stringify(stats));
        }
        // æ›´æ–°ç»Ÿè®¡æ˜¾ç¤º
        function updateStatsDisplay() {
            const today = new Date().toDateString();
            
            // è®¡ç®—å½“å¤©å®Œæˆçš„ç•ªèŒ„æ•°
            const todayPomodoros = records.pomo.filter(record => record.date === today).length;
            
            // è®¡ç®—å½“å¤©çš„ä¸“æ³¨æ—¶é•¿ï¼ˆåˆ†é’Ÿï¼‰
            const todayFocusTime = records.pomo
                .filter(record => record.date === today)
                .reduce((total, record) => total + record.duration, 0);
            
            // è¿ç»­å®Œæˆä¿æŒä¸ºå½“å‰ä¼šè¯çš„è¿ç»­è®°å½•
            
            // æ›´æ–°æ˜¾ç¤º
            completedPomodoros.textContent = todayPomodoros;
            focusTime.textContent = `${Math.round(todayFocusTime)}åˆ†é’Ÿ`;
            currentStreak.textContent = stats.currentStreak;
        }

        // ================= ä»Šæ—¥è®¡åˆ’æ¨¡å— =================
        // ç”Ÿæˆå”¯ä¸€ID
        function generateId() {
            return Date.now() + Math.random().toString(36).substr(2, 5);
        }
        // è·å–è®¡åˆ’åç§°
        function getPlanName(id) {
            const plan = plans.find(p => p.id === id);
            return plan ? plan.name : '';
        }
        // æ·»åŠ è®¡åˆ’
        function addPlanItem() {
            const name = planInput.value.trim();
            const expectPomo = parseInt(planPomo.value);
            const priority = document.getElementById('plan-priority').value;
            const goalId = document.getElementById('goal-select').value;
            const stageId = document.getElementById('stage-select').value;
            
            if (!name || isNaN(expectPomo)) return;
            // ç•ªèŒ„æ•°ä¸Šé™é™åˆ¶
            const maxPomo = 20;
            if (expectPomo > maxPomo) {
                alert(`é¢„è®¡ç•ªèŒ„æ•°ä¸èƒ½è¶…è¿‡${maxPomo}ä¸ªï¼Œè¯·è®¾ç½®åˆç†çš„ç›®æ ‡ã€‚`);
                planPomo.value = maxPomo;
                return;
            }
            const newPlan = {
                id: generateId(),
                name,
                expectPomo,
                finishPomo: 0,
                isCompleted: false,
                priority,
                createTime: new Date().toLocaleDateString(),
                order: Date.now(), // ç”¨äºæ‹–æ‹½æ’åº
                relatedGoalId: goalId || null,
                relatedStageId: stageId || null
            };
            plans.push(newPlan);
            savePlans();
            renderPlans();
            planInput.value = '';
            planPomo.value = 1;
            document.getElementById('plan-priority').value = 'medium';
            document.getElementById('goal-select').value = '';
            document.getElementById('stage-select').value = '';
            document.getElementById('stage-select').disabled = true;
        }
        // æ¸²æŸ“è®¡åˆ’åˆ—è¡¨
        function renderPlans() {
            if (plans.length === 0) {
                planList.innerHTML = '';
                planEmpty.classList.remove('hidden');
                return;
            }
            planEmpty.classList.add('hidden');
            
            // æŒ‰ä¼˜å…ˆçº§å’Œåˆ›å»ºæ—¶é—´æ’åº
            const sortedPlans = [...plans].sort((a, b) => {
                const priorityOrder = { high: 0, medium: 1, low: 2 };
                if (priorityOrder[a.priority] !== priorityOrder[b.priority]) {
                    return priorityOrder[a.priority] - priorityOrder[b.priority];
                }
                return (a.order || 0) - (b.order || 0);
            });
            
            planList.innerHTML = sortedPlans.map(plan => {
                const priorityClass = plan.priority === 'high' ? 'text-primary font-medium' : 
                                     plan.priority === 'medium' ? 'text-gray-dark' : 'text-gray-mid';
                const priorityText = plan.priority === 'high' ? 'ğŸ”´' : 
                                    plan.priority === 'medium' ? 'ğŸŸ¡' : 'ğŸ”µ';
                return `
                    <div class="flex items-center justify-between p-2 border-b border-light list-hover drag-item fade-in card-hover ${plan.isCompleted ? 'opacity-60 line-through' : ''}" 
                         draggable="true" data-plan-id="${plan.id}"
                         ondragover="event.preventDefault()"
                         ondrop="handlePlanDrop(event, '${plan.id}')"
                         ondragstart="handlePlanDragStart(event, '${plan.id}')"
                         onclick="completePlan('${plan.id}')">
                        <div class="flex items-center gap-2">
                            <span class="${priorityClass}">${priorityText} ${plan.name} <small class="text-gray-mid">(${plan.finishPomo}/${plan.expectPomo}ç•ªèŒ„)</small></span>
                        </div>
                        <div class="flex gap-2">
                            <button onclick="bindPlan('${plan.id}')" class="text-blue hover:text-blue/80" title="å…³è”ç•ªèŒ„è®¡æ—¶å™¨">
                                <i class="fa fa-link ${currentBindPlan === plan.id ? 'text-primary' : ''}"></i>
                            </button>
                            <button onclick="event.stopPropagation(); deletePlan('${plan.id}')" class="text-gray-mid hover:text-primary">
                                <i class="fa fa-trash"></i>
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
        }
        // å…³è”è®¡åˆ’åˆ°è®¡æ—¶å™¨
        function bindPlan(id) {
            currentBindPlan = currentBindPlan === id ? null : id;
            updateTimerDisplay();
            renderPlans();
        }
        // æ›´æ–°è®¡åˆ’ç•ªèŒ„æ•°
        function updatePlanPomo(id) {
            const plan = plans.find(p => p.id === id);
            if (!plan || plan.isCompleted) return;
            plan.finishPomo++;
            // å®Œæˆæ¡ä»¶ï¼šå®é™…ç•ªèŒ„æ•°â‰¥é¢„è®¡ç•ªèŒ„æ•°
            if (plan.finishPomo >= plan.expectPomo) plan.isCompleted = true;
            savePlans();
            renderPlans();
            // è®°å½•è®¡åˆ’å®Œæˆ
            recordPlan(plan.id);
            // æ›´æ–°æ•°æ®åˆ†æ
            updateDataMetrics(getActiveTab());
        }
        // æ ‡è®°è®¡åˆ’å®Œæˆ
        function completePlan(id) {
            const plan = plans.find(p => p.id === id);
            if (!plan) return;
            plan.isCompleted = !plan.isCompleted;
            savePlans();
            renderPlans();
            recordPlan(id);
            updateDataMetrics(getActiveTab());
            
            // æ–°å¢ï¼šæ›´æ–°ç›®æ ‡è¿›åº¦
            if (plan.isCompleted && plan.relatedGoalId && plan.relatedStageId) {
                updateGoalProgressOnPlanComplete(plan);
            }
            
            // æ˜¾ç¤ºå®ŒæˆåŠ¨æ•ˆ
            const planElement = document.querySelector(`[data-plan-id="${id}"]`);
            if (planElement && plan.isCompleted) {
                showCompletionEffect(planElement);
            }
        }
        // åˆ é™¤è®¡åˆ’
        function deletePlan(id) {
            if (confirm('ç¡®å®šåˆ é™¤è¯¥è®¡åˆ’å—ï¼Ÿ')) {
                plans = plans.filter(p => p.id !== id);
                if (currentBindPlan === id) currentBindPlan = null;
                savePlans();
                renderPlans();
                updateTimerDisplay();
            }
        }
        // ä¿å­˜è®¡åˆ’
        function savePlans() {
            localStorage.setItem('pomodoroPlans', JSON.stringify(plans));
        }

        // ================= æ—¥å¸¸ä¹ æƒ¯æ¨¡å— =================
        // æ·»åŠ ä¹ æƒ¯
        function addHabitItem() {
            const name = habitInput.value.trim();
            const type = habitType.value;
            const reminder = document.getElementById('habit-reminder').value;
            if (!name) return;
            const newHabit = {
                id: generateId(),
                name,
                type,
                reminder,
                streak: 0,
                lastCheckin: null,
                checkins: []
            };
            habits.push(newHabit);
            saveHabits();
            renderHabits();
            habitInput.value = '';
            document.getElementById('habit-reminder').value = '';
            // è®¾ç½®æé†’
            if (reminder && 'Notification' in window) {
                requestNotificationPermission();
            }
        }
        // æ¸²æŸ“ä¹ æƒ¯åˆ—è¡¨
        function renderHabits() {
            if (habits.length === 0) {
                habitList.innerHTML = '';
                habitEmpty.classList.remove('hidden');
                return;
            }
            habitEmpty.classList.add('hidden');
            habitList.innerHTML = habits.map(habit => {
                const isCheckedToday = isHabitCheckedToday(habit);
                const streak = getHabitStreak(habit);
                return `
                    <div class="flex items-center justify-between p-2 border-b border-light list-hover" data-habit-id="${habit.id}">
                        <div class="flex items-center gap-2">
                            <button onclick="toggleHabitCheckin('${habit.id}')" class="w-4 h-4 rounded-full flex items-center justify-center ${isCheckedToday ? 'bg-primary text-white' : 'border border-light text-gray-mid'}">
                                ${isCheckedToday ? '<i class="fa fa-check text-xs"></i>' : ''}
                            </button>
                            <span>${habit.name} <small class="text-gray-mid">${habit.type === 'daily' ? 'æ¯æ—¥' : 'æ¯å‘¨'} Â· è¿ç»­${streak}å¤©</small></span>
                        </div>
                        <div class="flex gap-2">
                            <button onclick="event.stopPropagation(); deleteHabit('${habit.id}')" class="text-gray-mid hover:text-primary">
                                <i class="fa fa-trash"></i>
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
        }
        // æ£€æŸ¥ä»Šæ—¥æ˜¯å¦å·²æ‰“å¡
        function isHabitCheckedToday(habit) {
            const today = new Date().toDateString();
            return habit.checkins.includes(today);
        }
        // è·å–ä¹ æƒ¯è¿ç»­æ‰“å¡å¤©æ•°
        function getHabitStreak(habit) {
            if (habit.checkins.length === 0) return 0;
            let streak = 0;
            const today = new Date();
            for (let i = 0; i < 365; i++) {
                const date = new Date(today);
                date.setDate(date.getDate() - i);
                const dateStr = date.toDateString();
                if (habit.checkins.includes(dateStr)) {
                    streak++;
                } else {
                    break;
                }
            }
            return streak;
        }
        // åˆ‡æ¢ä¹ æƒ¯æ‰“å¡çŠ¶æ€
        function toggleHabitCheckin(id) {
            const habit = habits.find(h => h.id === id);
            if (!habit) return;
            const today = new Date().toDateString();
            const checkinIndex = habit.checkins.indexOf(today);
            const isNewCheckin = checkinIndex === -1;
            
            if (checkinIndex > -1) {
                habit.checkins.splice(checkinIndex, 1);
            } else {
                habit.checkins.push(today);
                habit.lastCheckin = today;
            }
            saveHabits();
            renderHabits();
            recordHabit(id);
            updateDataMetrics(getActiveTab());
            
            // æ˜¾ç¤ºå®ŒæˆåŠ¨æ•ˆï¼ˆä»…åœ¨æ–°æ‰“å¡æ—¶ï¼‰
            if (isNewCheckin) {
                const habitElement = document.querySelector(`[data-habit-id="${id}"]`);
                if (habitElement) {
                    showCompletionEffect(habitElement);
                }
            }
        }
        // åˆ é™¤ä¹ æƒ¯
        function deleteHabit(id) {
            if (confirm('ç¡®å®šåˆ é™¤è¯¥ä¹ æƒ¯å—ï¼Ÿ')) {
                habits = habits.filter(h => h.id !== id);
                saveHabits();
                renderHabits();
            }
        }
        // ä¿å­˜ä¹ æƒ¯
        function saveHabits() {
            localStorage.setItem('pomodoroHabits', JSON.stringify(habits));
        }

        // ================= é•¿æœŸç›®æ ‡æ¨¡å— =================
        // æ·»åŠ ç›®æ ‡
        function addGoalItem() {
            const name = goalInput.value.trim();
            const stageCount = parseInt(goalStage.value);
            if (!name || isNaN(stageCount)) return;
            const stages = Array.from({length: stageCount}, (_, i) => ({
                id: generateId(),
                name: `é˜¶æ®µ${i + 1}`,
                isCompleted: false
            }));
            const newGoal = {
                id: generateId(),
                name,
                stages,
                createTime: new Date().toLocaleDateString()
            };
            goals.push(newGoal);
            saveGoals();
            renderGoals();
            updateGoalSelect(); // æ–°å¢ï¼šæ›´æ–°ç›®æ ‡é€‰æ‹©å™¨
            goalInput.value = '';
            goalStage.value = 3;
        }
        // æ¸²æŸ“ç›®æ ‡åˆ—è¡¨
        function renderGoals() {
            if (goals.length === 0) {
                goalList.innerHTML = '';
                goalEmpty.classList.remove('hidden');
                return;
            }
            goalEmpty.classList.add('hidden');
            goalList.innerHTML = goals.map(goal => {
                const completedStages = goal.stages.filter(s => s.isCompleted).length;
                const totalStages = goal.stages.length;
                const progress = (completedStages / totalStages) * 100;
                return `
                    <div class="p-3 border-b border-light list-hover">
                        <div class="flex justify-between items-center mb-2">
                            <h4 class="font-medium text-gray-dark">${goal.name}</h4>
                            <button onclick="event.stopPropagation(); deleteGoal('${goal.id}')" class="text-gray-mid hover:text-primary">
                                <i class="fa fa-trash"></i>
                            </button>
                        </div>
                        <div class="mb-2">
                            <div class="flex justify-between text-xs text-gray-mid mb-1">
                                <span>è¿›åº¦</span>
                                <span>${completedStages}/${totalStages}</span>
                            </div>
                            <div class="w-full bg-light rounded-full h-2">
                                <div class="bg-primary h-2 rounded-full" style="width: ${progress}%"></div>
                            </div>
                        </div>
                        <div class="grid grid-cols-3 gap-1">
                            ${goal.stages.map(stage => `
                                <button onclick="toggleGoalStage('${goal.id}', '${stage.id}')" 
                                    class="text-xs py-1 px-2 rounded ${stage.isCompleted ? 'bg-primary text-white' : 'bg-light text-gray-dark'}">
                                    ${stage.name}
                                </button>
                            `).join('')}
                        </div>
                    </div>
                `;
            }).join('');
        }
        // åˆ‡æ¢ç›®æ ‡é˜¶æ®µå®ŒæˆçŠ¶æ€
        function toggleGoalStage(goalId, stageId) {
            const goal = goals.find(g => g.id === goalId);
            if (!goal) return;
            const stage = goal.stages.find(s => s.id === stageId);
            if (!stage) return;
            stage.isCompleted = !stage.isCompleted;
            saveGoals();
            renderGoals();
        }
        // åˆ é™¤ç›®æ ‡
        function deleteGoal(id) {
            if (confirm('ç¡®å®šåˆ é™¤è¯¥ç›®æ ‡å—ï¼Ÿ')) {
                goals = goals.filter(g => g.id !== id);
                saveGoals();
                renderGoals();
            }
        }
        // ä¿å­˜ç›®æ ‡
        function saveGoals() {
            localStorage.setItem('pomodoroGoals', JSON.stringify(goals));
        }

        // ================= æ•°æ®åˆ†ææ¨¡å— =================
        // åˆå§‹åŒ–å›¾è¡¨
        function initChart(period) {
            if (chartInstance) {
                chartInstance.destroy();
            }
            const ctx = pomodoroChart.getContext('2d');
            const data = getChartData(period);
            
            // æ£€æŸ¥æ˜¯å¦æœ‰æ•°æ®
            const hasData = data.pomo.some(value => value > 0) || 
                           data.plan.some(value => value > 0) || 
                           data.habit.some(value => value > 0);
            
            if (!hasData) {
                // æ˜¾ç¤ºç©ºæ•°æ®æç¤º
                pomodoroChart.style.display = 'none';
                document.getElementById('no-data-message').style.display = 'flex';
                return;
            } else {
                // éšè—ç©ºæ•°æ®æç¤ºï¼Œæ˜¾ç¤ºå›¾è¡¨
                pomodoroChart.style.display = 'block';
                document.getElementById('no-data-message').style.display = 'none';
            }
            
            chartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: data.labels,
                    datasets: [
                        {
                            label: 'ç•ªèŒ„æ•°',
                            data: data.pomo,
                            backgroundColor: 'var(--primary-color)',
                            borderColor: 'var(--primary-color)',
                            borderWidth: 1
                        },
                        {
                            label: 'å®Œæˆè®¡åˆ’æ•°',
                            data: data.plan,
                            backgroundColor: 'color-mix(in srgb, var(--primary-color) 30%, transparent)',
                            borderColor: 'var(--primary-color)',
                            borderWidth: 1
                        },
                        {
                            label: 'æ‰“å¡ä¹ æƒ¯æ•°',
                            data: data.habit,
                            backgroundColor: 'color-mix(in srgb, var(--primary-color) 60%, transparent)',
                            borderColor: 'var(--primary-color)',
                            borderWidth: 1
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top',
                            labels: {
                                usePointStyle: true,
                                font: {
                                    size: 10
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                font: {
                                    size: 10
                                }
                            }
                        },
                        x: {
                            ticks: {
                                font: {
                                    size: 10
                                }
                            }
                        }
                    }
                }
            });
        }
        // è·å–å›¾è¡¨æ•°æ®
        function getChartData(period) {
            const today = new Date();
            let labels = [];
            let pomoData = [];
            let planData = [];
            let habitData = [];

            if (period === 'day') {
                // ä»Šæ—¥æ¯å°æ—¶æ•°æ®
                for (let i = 0; i < 24; i++) {
                    labels.push(`${i}:00`);
                    pomoData.push(getPomoCountByHour(today, i));
                    planData.push(getPlanCountByHour(today, i));
                    habitData.push(getHabitCountByHour(today, i));
                }
            } else if (period === 'week') {
                // æœ¬å‘¨æ¯å¤©æ•°æ®
                for (let i = 6; i >= 0; i--) {
                    const date = new Date(today);
                    date.setDate(date.getDate() - i);
                    labels.push(getWeekdayName(date));
                    pomoData.push(getPomoCountByDate(date));
                    planData.push(getPlanCountByDate(date));
                    habitData.push(getHabitCountByDate(date));
                }
            } else if (period === 'month') {
                // æœ¬æœˆæ¯å¤©æ•°æ®
                const daysInMonth = new Date(today.getFullYear(), today.getMonth() + 1, 0).getDate();
                for (let i = 0; i < daysInMonth; i++) {
                    const date = new Date(today.getFullYear(), today.getMonth(), i + 1);
                    if (date > today) break;
                    labels.push(`${i + 1}æ—¥`);
                    pomoData.push(getPomoCountByDate(date));
                    planData.push(getPlanCountByDate(date));
                    habitData.push(getHabitCountByDate(date));
                }
            }

            return { labels, pomo: pomoData, plan: planData, habit: habitData };
        }
        // è·å–æ˜ŸæœŸåç§°
        function getWeekdayName(date) {
            const weekdays = ['å‘¨æ—¥', 'å‘¨ä¸€', 'å‘¨äºŒ', 'å‘¨ä¸‰', 'å‘¨å››', 'å‘¨äº”', 'å‘¨å…­'];
            return weekdays[date.getDay()];
        }
        // è·å–æŒ‡å®šå°æ—¶çš„ç•ªèŒ„æ•°
        function getPomoCountByHour(date, hour) {
            const dateStr = date.toDateString();
            return records.pomo.filter(r => 
                r.date === dateStr && 
                new Date(r.time).getHours() === hour
            ).length;
        }
        // è·å–æŒ‡å®šæ—¥æœŸçš„ç•ªèŒ„æ•°
        function getPomoCountByDate(date) {
            const dateStr = date.toDateString();
            return records.pomo.filter(r => r.date === dateStr).length;
        }
        // è·å–æŒ‡å®šæ—¥æœŸçš„æ ‡ç­¾ç•ªèŒ„æ•°
        function getPomoCountByTag(date, tag) {
            const dateStr = date.toDateString();
            return records.pomo.filter(r => r.date === dateStr && r.tag === tag).length;
        }
        // è·å–æŒ‡å®šå°æ—¶çš„è®¡åˆ’å®Œæˆæ•°
        function getPlanCountByHour(date, hour) {
            const dateStr = date.toDateString();
            return records.plan.filter(r => 
                r.date === dateStr && 
                new Date(r.time).getHours() === hour
            ).length;
        }
        // è·å–æŒ‡å®šæ—¥æœŸçš„è®¡åˆ’å®Œæˆæ•°
        function getPlanCountByDate(date) {
            const dateStr = date.toDateString();
            return records.plan.filter(r => r.date === dateStr).length;
        }
        // è·å–æŒ‡å®šå°æ—¶çš„ä¹ æƒ¯æ‰“å¡æ•°
        function getHabitCountByHour(date, hour) {
            const dateStr = date.toDateString();
            return records.habit.filter(r => 
                r.date === dateStr && 
                new Date(r.time).getHours() === hour
            ).length;
        }
        // è·å–æŒ‡å®šæ—¥æœŸçš„ä¹ æƒ¯æ‰“å¡æ•°
        function getHabitCountByDate(date) {
            const dateStr = date.toDateString();
            return records.habit.filter(r => r.date === dateStr).length;
        }
        // æ›´æ–°æ•°æ®æŒ‡æ ‡
        function updateDataMetrics(period) {
            const today = new Date();
            let days = 1;
            if (period === 'week') days = 7;
            else if (period === 'month') days = 30;

            // ç•ªèŒ„å®Œæˆç‡
            const totalPomo = records.pomo.filter(r => {
                const recordDate = new Date(r.date);
                const diffDays = Math.floor((today - recordDate) / (1000 * 60 * 60 * 24));
                return diffDays < days;
            }).length;
            const avgPomoPerDay = Math.round(totalPomo / days);
            pomoRate.textContent = `${avgPomoPerDay > 0 ? Math.min(100, Math.round((totalPomo / (avgPomoPerDay * days)) * 100)) : 0}%`;

            // è®¡åˆ’å®Œæˆç‡
            const completedPlans = plans.filter(p => p.isCompleted).length;
            planRate.textContent = `${plans.length > 0 ? Math.round((completedPlans / plans.length) * 100) : 0}%`;

            // ä¹ æƒ¯æ‰“å¡ç‡
            let totalCheckins = 0;
            let totalPossibleCheckins = 0;
            habits.forEach(habit => {
                const checkins = habit.checkins.filter(c => {
                    const checkinDate = new Date(c);
                    const diffDays = Math.floor((today - checkinDate) / (1000 * 60 * 60 * 24));
                    return diffDays < (habit.type === 'daily' ? days : 4);
                }).length;
                totalCheckins += checkins;
                totalPossibleCheckins += habit.type === 'daily' ? days : 4;
            });
            habitRate.textContent = `${totalPossibleCheckins > 0 ? Math.round((totalCheckins / totalPossibleCheckins) * 100) : 0}%`;

            // å¹³å‡ä¸“æ³¨æ—¶é•¿
            const avgFocusTime = totalPomo > 0 ? Math.round((stats.focusTime / totalPomo) * 25) : 0;
            avgFocus.textContent = `${avgFocusTime}åˆ†é’Ÿ`;
        }
        // è·å–å½“å‰æ¿€æ´»çš„æ ‡ç­¾é¡µ
        function getActiveTab() {
            const activeTab = document.querySelector('.data-tab.active');
            return activeTab ? activeTab.dataset.tab : 'day';
        }
        // åˆ‡æ¢æ•°æ®æ ‡ç­¾é¡µ
        function switchDataTab(tab) {
            dataTabs.forEach(t => t.classList.remove('active', 'bg-primary', 'text-white'));
            dataTabs.forEach(t => t.classList.add('bg-light', 'text-gray-dark'));
            const targetTab = document.querySelector(`[data-tab="${tab}"]`);
            if (targetTab) {
                targetTab.classList.add('active', 'bg-primary', 'text-white');
                targetTab.classList.remove('bg-light', 'text-gray-dark');
            }
            initChart(tab);
            updateDataMetrics(tab);
        }

        // ================= è®°å½•æ•°æ® =================
        // è®°å½•ç•ªèŒ„æ•°æ®
        function recordPomo() {
            const pomoRecord = {
                id: generateId(),
                date: new Date().toDateString(),
                time: new Date().toISOString(),
                tag: currentPomoTag,
                planId: currentBindPlan,
                duration: workTime / 60
            };
            records.pomo.push(pomoRecord);
            saveRecords();
            // æ›´æ–°ç•ªèŒ„æ˜ç»†
            renderPomoDetail();
        }
        // è®°å½•è®¡åˆ’å®Œæˆ
        function recordPlan(planId) {
            records.plan.push({
                id: generateId(),
                planId,
                date: new Date().toDateString(),
                time: new Date().toISOString()
            });
            saveRecords();
        }
        // è®°å½•ä¹ æƒ¯æ‰“å¡
        function recordHabit(habitId) {
            records.habit.push({
                id: generateId(),
                habitId,
                date: new Date().toDateString(),
                time: new Date().toISOString()
            });
            saveRecords();
        }
        // ä¿å­˜è®°å½•
        function saveRecords() {
            localStorage.setItem('pomodoroRecords', JSON.stringify(records));
        }

        // ================= äº‹ä»¶ç»‘å®š =================
        function bindEvents() {
            // è®¡æ—¶å™¨æ§åˆ¶
            startBtn.addEventListener('click', toggleTimer);
            resetBtn.addEventListener('click', resetTimer);
            workMode.addEventListener('click', () => toggleMode('work'));
            breakMode.addEventListener('click', () => toggleMode('break'));
            workTimeInput.addEventListener('change', updateTimeSettings);
            breakTimeInput.addEventListener('change', updateTimeSettings);

            // ç•ªèŒ„æ ‡ç­¾
            document.getElementById('tag-work').addEventListener('click', () => switchPomoTag('work'));
            document.getElementById('tag-study').addEventListener('click', () => switchPomoTag('study'));
            document.getElementById('tag-life').addEventListener('click', () => switchPomoTag('life'));

            // è®¡åˆ’æ¨¡å—
            addPlan.addEventListener('click', addPlanItem);
            planInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') addPlanItem();
            });
            
            // æ–°å¢ï¼šè®¡åˆ’æ¨¡æ¿
            document.getElementById('save-template-btn').addEventListener('click', saveAsTemplate);
            document.getElementById('template-select').addEventListener('change', (e) => loadTemplate(e.target.value));
            
            // æ–°å¢ï¼šç›®æ ‡å…³è”
            document.getElementById('goal-select').addEventListener('change', (e) => updateStageSelect(e.target.value));

            // ä¹ æƒ¯æ¨¡å—
            addHabit.addEventListener('click', addHabitItem);
            habitInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') addHabitItem();
            });

            // ç›®æ ‡æ¨¡å—
            addGoal.addEventListener('click', addGoalItem);
            goalInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') addGoalItem();
            });

            // æ•°æ®å¤‡ä»½
            document.getElementById('export-data').addEventListener('click', exportData);
            document.getElementById('import-data').addEventListener('click', () => {
                document.getElementById('import-file').click();
            });
            document.getElementById('import-file').addEventListener('change', importData);

            // ç•ªèŒ„æ˜ç»†ç­›é€‰
            document.getElementById('pomo-tag-filter').addEventListener('change', renderPomoDetail);

            // æŠ˜å æ¨¡å—
            collapseHeaders.forEach((header, index) => {
                header.addEventListener('click', () => toggleCollapse(index));
            });

            // æ•°æ®åˆ†æ
            dataTabs.forEach(tab => {
                tab.addEventListener('click', () => switchDataTab(tab.dataset.tab));
            });
            
            // æ–°å¢ï¼šä¸»é¢˜è®¾ç½®
            document.getElementById('theme-toggle').addEventListener('click', toggleDarkMode);
            document.getElementById('primary-color').addEventListener('change', (e) => setPrimaryColor(e.target.value));
            
            // æ–°å¢ï¼šå­—ä½“å¤§å°
            document.querySelectorAll('.font-size-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const size = e.target.dataset.size;
                    setFontSize(size);
                    document.querySelectorAll('.font-size-btn').forEach(b => b.classList.remove('bg-light/80'));
                    e.target.classList.add('bg-light/80');
                });
            });
            
            // æ–°å¢ï¼šç™½å™ªéŸ³æ§åˆ¶
            document.getElementById('whitenoise-toggle').addEventListener('click', toggleWhiteNoise);
            document.getElementById('whitenoise-type').addEventListener('change', (e) => setWhiteNoiseType(e.target.value));
            document.getElementById('whitenoise-volume').addEventListener('input', (e) => setWhiteNoiseVolume(e.target.value));
            document.getElementById('play-during-break').addEventListener('change', (e) => setPlayDuringBreak(e.target.checked));
            
            // æ–°å¢ï¼šè®¾ç½®é¢æ¿æ§åˆ¶
            document.getElementById('settings-toggle').addEventListener('click', toggleSettingsPanel);
            document.getElementById('close-settings').addEventListener('click', toggleSettingsPanel);
            // ç‚¹å‡»é®ç½©å±‚å…³é—­è®¾ç½®é¢æ¿
            document.getElementById('settings-panel').addEventListener('click', (e) => {
                if (e.target.id === 'settings-panel') {
                    toggleSettingsPanel();
                }
            });
            
            // æ–°å¢ï¼šå¼€å§‹ç¬¬ä¸€ä¸ªç•ªèŒ„æŒ‰é’®
            const startFirstPomoBtn = document.getElementById('start-first-pomo-btn');
            if (startFirstPomoBtn) {
                startFirstPomoBtn.addEventListener('click', () => {
                    // æ»šåŠ¨åˆ°é¡µé¢é¡¶éƒ¨çš„ç•ªèŒ„é’Ÿéƒ¨åˆ†
                    window.scrollTo({
                        top: 0,
                        behavior: 'smooth'
                    });
                    // å¯åŠ¨è®¡æ—¶å™¨
                    toggleTimer();
                    // å…³é—­è®¾ç½®é¢æ¿ï¼ˆå¦‚æœæ‰“å¼€ï¼‰
                    const settingsPanel = document.getElementById('settings-panel');
                    if (settingsPanel && settingsPanel.style.display === 'flex') {
                        toggleSettingsPanel();
                    }
                });
            }
        }

        // ================= æŠ˜å åŠŸèƒ½ =================
        function toggleCollapse(index) {
            const contents = [
                ['plan-collapse', 'plan-list'],
                ['habit-collapse', 'habit-list'],
                ['goal-collapse', 'goal-list'],
                ['data-collapse', 'data-chart-collapse', 'data-metric-collapse', 'pomo-detail-collapse']
            ];
            
            contents[index].forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    element.classList.toggle('collapse-open');
                }
            });
            
            const icon = collapseIcons[index];
            if (icon) {
                icon.classList.toggle('fa-chevron-down');
                icon.classList.toggle('fa-chevron-up');
            }
        }

        // ================= ç•ªèŒ„æ ‡ç­¾åŠŸèƒ½ =================
        function switchPomoTag(tag) {
            currentPomoTag = tag;
            // æ›´æ–°æŒ‰é’®æ ·å¼
            ['work', 'study', 'life'].forEach(t => {
                const button = document.getElementById(`tag-${t}`);
                if (t === tag) {
                    button.classList.add('bg-primary', 'text-white');
                    button.classList.remove('bg-light', 'text-gray-dark');
                } else {
                    button.classList.add('bg-light', 'text-gray-dark');
                    button.classList.remove('bg-primary', 'text-white');
                }
            });
        }

        // ================= ä¹ æƒ¯æé†’åŠŸèƒ½ =================
        function requestNotificationPermission() {
            if (Notification.permission === 'default') {
                Notification.requestPermission().then(permission => {
                    if (permission === 'granted') {
                        console.log('é€šçŸ¥æƒé™å·²è·å–');
                    }
                });
            }
        }

        // æ£€æŸ¥å¹¶å‘é€ä¹ æƒ¯æé†’
        function checkHabitReminders() {
            const now = new Date();
            const currentTime = now.getHours().toString().padStart(2, '0') + ':' + now.getMinutes().toString().padStart(2, '0');
            
            habits.forEach(habit => {
                if (habit.reminder === currentTime && !isHabitCheckedToday(habit)) {
                    if (Notification.permission === 'granted') {
                        new Notification('ä¹ æƒ¯æé†’', {
                            body: `æ˜¯æ—¶å€™å®Œæˆä¹ æƒ¯ï¼š${habit.name}`,
                            icon: 'https://cdn-icons-png.flaticon.com/512/2534/2534659.png'
                        });
                    }
                }
            });
        }

        // ================= æ•°æ®å¤‡ä»½åŠŸèƒ½ =================
        function exportData() {
            const data = {
                stats,
                plans,
                habits,
                goals,
                records,
                exportTime: new Date().toISOString()
            };
            const dataStr = JSON.stringify(data, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'text/plain' });
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `pomodoro-data-${new Date().toISOString().split('T')[0]}.txt`;
            link.click();
            URL.revokeObjectURL(url);
            alert('æ•°æ®å¯¼å‡ºæˆåŠŸï¼');
        }

        function importData(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    if (confirm('ç¡®å®šè¦å¯¼å…¥æ•°æ®å—ï¼Ÿè¿™å°†è¦†ç›–å½“å‰æ‰€æœ‰æ•°æ®ã€‚')) {
                        stats = data.stats || { completedPomodoros: 0, focusTime: 0, currentStreak: 0 };
                        plans = data.plans || [];
                        habits = data.habits || [];
                        goals = data.goals || [];
                        records = data.records || { pomo: [], plan: [], habit: [], focus: [] };
                        
                        // ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨
                        saveStats();
                        savePlans();
                        saveHabits();
                        saveGoals();
                        saveRecords();
                        
                        // é‡æ–°æ¸²æŸ“æ‰€æœ‰æ¨¡å—
                        renderPlans();
                        renderHabits();
                        renderGoals();
                        renderPomoDetail();
                        updateStatsDisplay();
                        updateDataMetrics(getActiveTab());
                        initChart(getActiveTab());
                        
                        alert('æ•°æ®å¯¼å…¥æˆåŠŸï¼');
                    }
                } catch (error) {
                    alert('æ•°æ®æ ¼å¼é”™è¯¯ï¼Œå¯¼å…¥å¤±è´¥ï¼');
                }
            };
            reader.readAsText(file);
            event.target.value = '';
        }

        // ================= ç•ªèŒ„æ˜ç»†åŠŸèƒ½ =================
        function renderPomoDetail() {
            const filter = document.getElementById('pomo-tag-filter').value;
            let filteredPomos = records.pomo;
            
            if (filter !== 'all') {
                filteredPomos = filteredPomos.filter(p => p.tag === filter);
            }
            
            // æŒ‰æ—¶é—´å€’åºæ’åº
            filteredPomos.sort((a, b) => new Date(b.time) - new Date(a.time));
            
            if (filteredPomos.length === 0) {
                document.getElementById('pomo-detail-list').innerHTML = '<div class="text-center text-gray-mid py-2 text-xs">æš‚æ— ç•ªèŒ„è®°å½•</div>';
                return;
            }
            
            document.getElementById('pomo-detail-list').innerHTML = filteredPomos.slice(0, 20).map(pomo => {
                const date = new Date(pomo.time);
                const timeStr = date.toLocaleString('zh-CN', { month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit' });
                const tagText = pomo.tag === 'work' ? 'ğŸ’¼ å·¥ä½œ' : 
                               pomo.tag === 'study' ? 'ğŸ“š å­¦ä¹ ' : 'ğŸ  ç”Ÿæ´»';
                const planName = pomo.planId ? getPlanName(pomo.planId) : '';
                
                return `
                    <div class="flex justify-between items-center p-1 border-b border-light/50">
                        <div class="flex items-center gap-2">
                            <span class="text-primary"><i class="fa fa-circle text-xs"></i></span>
                            <span class="text-xs">${tagText}</span>
                            ${planName ? `<span class="text-xs text-gray-mid">${planName}</span>` : ''}
                        </div>
                        <div class="text-xs text-gray-mid">${timeStr}</div>
                    </div>
                `;
            }).join('');
        }

        // ================= æ‹–æ‹½æ’åºåŠŸèƒ½ =================
        let draggedPlanId = null;

        function handlePlanDragStart(event, planId) {
            draggedPlanId = planId;
            event.dataTransfer.effectAllowed = 'move';
            event.target.classList.add('opacity-50');
        }

        function handlePlanDrop(event, targetPlanId) {
            event.preventDefault();
            if (!draggedPlanId || draggedPlanId === targetPlanId) return;

            const draggedPlan = plans.find(p => p.id === draggedPlanId);
            const targetPlan = plans.find(p => p.id === targetPlanId);
            
            if (draggedPlan && targetPlan) {
                // äº¤æ¢orderå€¼å®ç°æ’åº
                const tempOrder = draggedPlan.order;
                draggedPlan.order = targetPlan.order;
                targetPlan.order = tempOrder;
                
                savePlans();
                renderPlans();
            }
            
            // æ¸…é™¤æ‹–æ‹½çŠ¶æ€
            document.querySelectorAll('.drag-item').forEach(item => {
                item.classList.remove('opacity-50');
            });
            draggedPlanId = null;
        }

        // ================= å®ŒæˆåŠ¨æ•ˆåŠŸèƒ½ =================
        function showCompletionEffect(element) {
            element.classList.add('bounce-in');
            setTimeout(() => {
                element.classList.remove('bounce-in');
            }, 500);
        }

        // ================= ä¸»é¢˜ç³»ç»ŸåŠŸèƒ½ =================
        // åº”ç”¨ä¸»é¢˜
        function applyTheme() {
            const root = document.documentElement;
            
            // åº”ç”¨æ·±è‰²/æµ…è‰²æ¨¡å¼
            if (settings.theme === 'dark') {
                root.classList.add('dark');
                document.getElementById('theme-toggle').innerHTML = '<i class="fa fa-sun-o"></i> æµ…è‰²æ¨¡å¼';
            } else {
                root.classList.remove('dark');
                document.getElementById('theme-toggle').innerHTML = '<i class="fa fa-moon-o"></i> æ·±è‰²æ¨¡å¼';
            }
            
            // åº”ç”¨è‡ªå®šä¹‰ä¸»è‰²
            const colorMap = {
                tomato: '#B52B2D',
                blue: '#2563EB',
                green: '#16A34A',
                purple: '#7E22CE'
            };
            root.style.setProperty('--primary-color', colorMap[settings.primaryColor] || '#B52B2D');
            
            // åº”ç”¨å­—ä½“å¤§å°
            const fontSizeMap = {
                small: '0.875rem',
                medium: '1rem',
                large: '1.125rem'
            };
            root.style.setProperty('--font-size', fontSizeMap[settings.fontSize] || '1rem');
            document.body.style.fontSize = fontSizeMap[settings.fontSize] || '1rem';
        }
        
        // åˆ‡æ¢æ·±è‰²æ¨¡å¼
        function toggleDarkMode() {
            settings.theme = settings.theme === 'light' ? 'dark' : 'light';
            applyTheme();
            saveSettings();
        }
        
        // è®¾ç½®ä¸»è‰²
        function setPrimaryColor(color) {
            settings.primaryColor = color;
            applyTheme();
            saveSettings();
        }
        
        // è®¾ç½®å­—ä½“å¤§å°
        function setFontSize(size) {
            settings.fontSize = size;
            applyTheme();
            saveSettings();
        }
        
        // ä¿å­˜è®¾ç½®
        function saveSettings() {
            localStorage.setItem('pomodoroSettings', JSON.stringify(settings));
        }

        // ================= ç™½å™ªéŸ³åŠŸèƒ½ =================
        // ç™½å™ªéŸ³éŸ³é¢‘URLæ˜ å°„
        const whiteNoiseUrls = {
            cafe: 'https://www.soundhelix.com/examples/mp3/SoundHelix-Song-1.mp3', // ç¤ºä¾‹URLï¼Œå®é™…åº”ä½¿ç”¨ä¸“é—¨çš„ç™½å™ªéŸ³éŸ³é¢‘
            rain: 'https://www.soundhelix.com/examples/mp3/SoundHelix-Song-2.mp3',
            library: 'https://www.soundhelix.com/examples/mp3/SoundHelix-Song-3.mp3',
            nature: 'https://www.soundhelix.com/examples/mp3/SoundHelix-Song-4.mp3'
        };
        
        // æ’­æ”¾ç™½å™ªéŸ³
        function playWhiteNoise() {
            if (!settings.whiteNoise.enabled) return;
            
            // åœæ­¢å½“å‰éŸ³é¢‘
            stopWhiteNoise();
            
            try {
                const audio = new Audio(whiteNoiseUrls[settings.whiteNoise.type] || whiteNoiseUrls.cafe);
                audio.loop = true;
                audio.volume = settings.whiteNoise.volume;
                audio.play().catch(error => {
                    console.log('ç™½å™ªéŸ³æ’­æ”¾å¤±è´¥:', error);
                });
                currentAudio = audio;
            } catch (error) {
                console.log('ç™½å™ªéŸ³åˆå§‹åŒ–å¤±è´¥:', error);
            }
        }
        
        // åœæ­¢ç™½å™ªéŸ³
        function stopWhiteNoise() {
            if (currentAudio) {
                currentAudio.pause();
                currentAudio = null;
            }
        }
        
        // åˆ‡æ¢ç™½å™ªéŸ³
        function toggleWhiteNoise() {
            settings.whiteNoise.enabled = !settings.whiteNoise.enabled;
            if (settings.whiteNoise.enabled) {
                if (isRunning && isWorkMode) {
                    playWhiteNoise();
                }
                document.getElementById('whitenoise-toggle').innerHTML = '<i class="fa fa-volume-off"></i> å…³é—­';
            } else {
                stopWhiteNoise();
                document.getElementById('whitenoise-toggle').innerHTML = '<i class="fa fa-volume-up"></i> å¼€å¯';
            }
            saveSettings();
        }
        
        // è®¾ç½®ç™½å™ªéŸ³ç±»å‹
        function setWhiteNoiseType(type) {
            settings.whiteNoise.type = type;
            if (settings.whiteNoise.enabled && isRunning && isWorkMode) {
                playWhiteNoise();
            }
            saveSettings();
        }
        
        // è®¾ç½®ç™½å™ªéŸ³éŸ³é‡
        function setWhiteNoiseVolume(volume) {
            settings.whiteNoise.volume = parseFloat(volume);
            if (currentAudio) {
                currentAudio.volume = settings.whiteNoise.volume;
            }
            saveSettings();
        }
        
        // è®¾ç½®ä¼‘æ¯æ—¶æ˜¯å¦æ’­æ”¾
        function setPlayDuringBreak(play) {
            settings.whiteNoise.playDuringBreak = play;
            saveSettings();
        }

        // ================= è®¡åˆ’æ¨¡æ¿åŠŸèƒ½ =================
        // ä¿å­˜å½“å‰è®¡åˆ’ä¸ºæ¨¡æ¿
        function saveAsTemplate() {
            const name = prompt('è¯·è¾“å…¥æ¨¡æ¿åç§°ï¼š');
            if (!name) return;
            
            const template = {
                id: generateId(),
                name,
                plans: JSON.parse(JSON.stringify(plans)),
                createTime: new Date().toLocaleDateString()
            };
            
            planTemplates.push(template);
            savePlanTemplates();
            updateTemplateSelect();
            alert('æ¨¡æ¿ä¿å­˜æˆåŠŸï¼');
        }
        
        // åŠ è½½æ¨¡æ¿
        function loadTemplate(templateId) {
            if (!templateId) return;
            
            const template = planTemplates.find(t => t.id === templateId);
            if (template) {
                if (confirm('åŠ è½½æ¨¡æ¿å°†è¦†ç›–å½“å‰æ‰€æœ‰è®¡åˆ’ï¼Œç¡®å®šç»§ç»­å—ï¼Ÿ')) {
                    plans = JSON.parse(JSON.stringify(template.plans));
                    savePlans();
                    renderPlans();
                    document.getElementById('template-select').value = '';
                }
            }
        }
        
        // åˆ é™¤æ¨¡æ¿
        function deleteTemplate(templateId) {
            if (confirm('ç¡®å®šåˆ é™¤è¯¥æ¨¡æ¿å—ï¼Ÿ')) {
                planTemplates = planTemplates.filter(t => t.id !== templateId);
                savePlanTemplates();
                updateTemplateSelect();
            }
        }
        
        // ä¿å­˜æ¨¡æ¿
        function savePlanTemplates() {
            localStorage.setItem('pomodoroPlanTemplates', JSON.stringify(planTemplates));
        }
        
        // æ›´æ–°æ¨¡æ¿é€‰æ‹©å™¨
        function updateTemplateSelect() {
            const select = document.getElementById('template-select');
            select.innerHTML = '<option value="">åŠ è½½æ¨¡æ¿</option>' + 
                planTemplates.map(t => `<option value="${t.id}">${t.name}</option>`).join('');
        }

        // ================= ç›®æ ‡å…³è”åŠŸèƒ½ =================
        // æ›´æ–°ç›®æ ‡é€‰æ‹©å™¨
        function updateGoalSelect() {
            const goalSelect = document.getElementById('goal-select');
            const stageSelect = document.getElementById('stage-select');
            
            goalSelect.innerHTML = '<option value="">å…³è”ç›®æ ‡ï¼ˆå¯é€‰ï¼‰</option>' +
                goals.map(g => `<option value="${g.id}">${g.name}</option>`).join('');
            
            stageSelect.innerHTML = '<option value="">é€‰æ‹©é˜¶æ®µ</option>';
            stageSelect.disabled = true;
        }
        
        // æ›´æ–°é˜¶æ®µé€‰æ‹©å™¨
        function updateStageSelect(goalId) {
            const stageSelect = document.getElementById('stage-select');
            const goal = goals.find(g => g.id === goalId);
            
            if (goal) {
                stageSelect.innerHTML = '<option value="">é€‰æ‹©é˜¶æ®µ</option>' +
                    goal.stages.map(s => `<option value="${s.id}">${s.name}</option>`).join('');
                stageSelect.disabled = false;
            } else {
                stageSelect.innerHTML = '<option value="">é€‰æ‹©é˜¶æ®µ</option>';
                stageSelect.disabled = true;
            }
        }
        
        // å®Œæˆè®¡åˆ’æ—¶æ›´æ–°ç›®æ ‡è¿›åº¦
        function updateGoalProgressOnPlanComplete(plan) {
            if (!plan.relatedGoalId || !plan.relatedStageId) return;
            
            const goal = goals.find(g => g.id === plan.relatedGoalId);
            if (!goal) return;
            
            const stage = goal.stages.find(s => s.id === plan.relatedStageId);
            if (!stage) return;
            
            // æ£€æŸ¥è¯¥é˜¶æ®µçš„æ‰€æœ‰å…³è”è®¡åˆ’æ˜¯å¦éƒ½å·²å®Œæˆ
            const relatedPlans = plans.filter(p => 
                p.relatedGoalId === plan.relatedGoalId && 
                p.relatedStageId === plan.relatedStageId
            );
            
            const completedRelatedPlans = relatedPlans.filter(p => p.isCompleted);
            
            if (relatedPlans.length > 0 && completedRelatedPlans.length === relatedPlans.length) {
                stage.isCompleted = true;
                saveGoals();
                renderGoals();
                
                // æ˜¾ç¤ºå®Œæˆæç¤º
                showNotification(`ğŸ‰ æ­å–œï¼ç›®æ ‡"${goal.name}"çš„"${stage.name}"é˜¶æ®µå·²å®Œæˆï¼`);
            }
        }
        
        // æ˜¾ç¤ºé€šçŸ¥
        function showNotification(message) {
            const notification = document.createElement('div');
            notification.className = 'fixed top-4 right-4 bg-primary text-white px-4 py-2 rounded-lg shadow-lg z-50 bounce-in';
            notification.textContent = message;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 3000);
        }
        
        // åˆ‡æ¢è®¾ç½®é¢æ¿
        function toggleSettingsPanel() {
            const settingsPanel = document.getElementById('settings-panel');
            const isVisible = !settingsPanel.classList.contains('hidden');
            
            if (isVisible) {
                settingsPanel.classList.add('hidden');
                document.body.style.overflow = 'auto'; // æ¢å¤æ»šåŠ¨
            } else {
                settingsPanel.classList.remove('hidden');
                document.body.style.overflow = 'hidden'; // ç¦æ­¢æ»šåŠ¨
                // é‡æ–°åº”ç”¨ä¸»é¢˜åˆ°è®¾ç½®é¢æ¿
                applyTheme();
            }
        }

        // ================= å…¨å±€å‡½æ•°æš´éœ² =================
        // é‡æ–°ç»‘å®šæ‰€æœ‰åˆ é™¤ç›¸å…³å‡½æ•°ï¼Œç¡®ä¿èƒ½æ­£ç¡®è®¿é—®
        window.deletePlan = function(id) {
            if (confirm('ç¡®å®šåˆ é™¤è¯¥è®¡åˆ’å—ï¼Ÿ')) {
                plans = plans.filter(p => p.id !== id);
                if (currentBindPlan === id) currentBindPlan = null;
                localStorage.setItem('pomodoroPlans', JSON.stringify(plans));
                renderPlans();
                updateTimerDisplay();
            }
        };
        
        window.deleteHabit = function(id) {
            if (confirm('ç¡®å®šåˆ é™¤è¯¥ä¹ æƒ¯å—ï¼Ÿ')) {
                habits = habits.filter(h => h.id !== id);
                localStorage.setItem('pomodoroHabits', JSON.stringify(habits));
                renderHabits();
            }
        };
        
        window.deleteGoal = function(id) {
            if (confirm('ç¡®å®šåˆ é™¤è¯¥ç›®æ ‡å—ï¼Ÿ')) {
                goals = goals.filter(g => g.id !== id);
                localStorage.setItem('pomodoroGoals', JSON.stringify(goals));
                renderGoals();
                updateGoalSelect(); // æ›´æ–°ç›®æ ‡é€‰æ‹©å™¨
            }
        };
        
        // ä¸»é¢˜ç›¸å…³å‡½æ•°
        window.toggleDarkMode = toggleDarkMode;
        window.setPrimaryColor = setPrimaryColor;
        window.setFontSize = setFontSize;
        
        // ç™½å™ªéŸ³ç›¸å…³å‡½æ•°
        window.toggleWhiteNoise = toggleWhiteNoise;
        window.setWhiteNoiseType = setWhiteNoiseType;
        window.setWhiteNoiseVolume = setWhiteNoiseVolume;
        window.setPlayDuringBreak = setPlayDuringBreak;
        
        // æ¨¡æ¿ç›¸å…³å‡½æ•°
        window.saveAsTemplate = saveAsTemplate;
        window.loadTemplate = loadTemplate;
        
        // å…¶ä»–å…¨å±€å‡½æ•°
        window.toggleTimer = toggleTimer;
        window.resetTimer = resetTimer;
        window.toggleMode = toggleMode;
        window.addPlanItem = addPlanItem;
        window.completePlan = completePlan;
        window.bindPlan = bindPlan;
        window.addHabitItem = addHabitItem;
        window.toggleHabitCheckin = toggleHabitCheckin;
        window.addGoalItem = addGoalItem;
        window.toggleGoalStage = toggleGoalStage;
        window.switchDataTab = switchDataTab;
        window.toggleCollapse = toggleCollapse;
        window.switchPomoTag = switchPomoTag;
        window.exportData = exportData;
        window.importData = importData;
        window.renderPomoDetail = renderPomoDetail;
        window.handlePlanDragStart = handlePlanDragStart;
        window.handlePlanDrop = handlePlanDrop;
        window.showCompletionEffect = showCompletionEffect;
    </script>
<script>
  // æ³¨å†Œ Service Worker
  if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
      navigator.serviceWorker.register('/service-worker.js')
        .then((registration) => {
          console.log('Service Worker æ³¨å†ŒæˆåŠŸ:', registration.scope);
        })
        .catch((error) => {
          console.log('Service Worker æ³¨å†Œå¤±è´¥:', error);
        });
    });
  }
</script>
</body></html>